<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º CSS —Ñ–∞–π–ª -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
  <style>
    html,
    body {
      position: relative;
      height: 100%;
      overflow: hidden;
    }

    body {
      background: #eee;
      font-family: Helvetica Neue, Helvetica, Arial, sans-serif;
      font-size: 14px;
      color: #000;
      margin: 0;
      padding: 0;
    }

    swiper-container {
      width: 100%;
      height: 100%;
    }

    swiper-slide {
      text-align: center;
      font-size: 18px;
      background: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    swiper-slide img {
      display: block;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
  </style>
</head>
<body>
    <!-- –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
  <swiper-container class="mySwiper" pagination="true" pagination-clickable="true" navigation="false" space-between="3"
    centered-slides="true" autoplay-delay="25000" autoplay-disable-on-interaction="false">
    <swiper-slide><img src="{{ url_for('static', filename='c3.jpg') }}" alt="Background Image" class="background-image"></swiper-slide>
    <swiper-slide><img src="{{ url_for('static', filename='c3rus.jpg') }}" alt="Background Image" class="background-image"></swiper-slide>
  </swiper-container>

  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-element-bundle.min.js"></script>

    <!-- –ö–Ω–æ–ø–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
    <a href="/settings">
        <button class="settings-button">
            <img src="{{ url_for('static', filename='settings.png') }}" alt="Settings Icon">
        </button>
    </a>

    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ç–∏ —Å –∏–∫–æ–Ω–∫–æ–π -->
    <div class="network-indicator">
        <img id="network-status-icon" class="offline" 
             src="{{ url_for('static', filename='web.png') }}" 
             alt="Network Status">
    </div>

    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–∏–Ω–≥–∞ —Å–µ—Ä–≤–µ—Ä–∞ -->
    <div id="ping-server-indicator" class="ping-indicator">
        <img id="ping-icon" src="{{ url_for('static', filename='ping_offline.png') }}" alt="Ping Status">
    </div>
<div style="visibility: hidden; width: 0; height:0; margin: 0; padding:0;">
  <h2>SIP.js –¢–µ–ª–µ—Ñ–æ–Ω (FreeSWITCH)</h2>

  <!-- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è SIP -->
  <div id="login-block">
    <input type="text" id="sip-username" placeholder="SIP Username">
    <input type="password" id="sip-password" placeholder="SIP Password">
    <input type="text" id="sip-domain" placeholder="SIP Domain (e.g., freeswitch.local)">
    <button onclick="registerSIP(); saveConfig();">–í–æ–π—Ç–∏</button>
  </div>

  <!-- –ó–≤–æ–Ω–∫–∏ -->
  <div id="call-block" style="display: none;">
    <input type="text" id="targetNumber" placeholder="–ö—É–¥–∞ –∑–≤–æ–Ω–∏—Ç—å">
    <button onclick="makeCall()">–ü–æ–∑–≤–æ–Ω–∏—Ç—å</button>
    <button onclick="hangupCall()">–°–±—Ä–æ—Å–∏—Ç—å</button>
    <p><b>–°—Ç–∞—Ç—É—Å:</b> <span id="status">–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω</span></p>

    <div>
      <h3>–õ–æ–∫–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ</h3>
      <video id="localVideo" autoplay muted playsinline style="width: 240px;"></video>
      <h3>–£–¥–∞–ª—ë–Ω–Ω–æ–µ –≤–∏–¥–µ–æ</h3>
      <video id="remoteVideo" autoplay playsinline style="width: 240px;"></video>
    </div>
  </div>

  <!-- –í—Ö–æ–¥—è—â–∏–π -->
  <div id="incoming-call" style="display:none;">
    <p>–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫</p>
    <button id="acceptBtn">–ü—Ä–∏–Ω—è—Ç—å</button>
    <button id="rejectBtn">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
  </div>
  <audio id="remoteAudio" autoplay></audio>
<audio id="ringback" src="{{ url_for('static', filename='ringback.wav') }}"></audio>

</div>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º JavaScript –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–∏–Ω–≥–∞ -->
    <script>
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ç–∏ (–ø–∏–Ω–≥ –Ω–∞ 8.8.8.8)
        function checkNetworkStatus() {
            fetch("/ping", { method: "GET" })
            .then(response => response.json())
            .then(data => {
                const isOnline = data.ping;
                if (isOnline) {
                    document.getElementById('network-status-icon').classList.remove('offline');
                    document.getElementById('network-status-icon').classList.add('online');
                    document.getElementById('network-status-icon').src = "{{ url_for('static', filename='web_online.png') }}"; 
                } else {
                    document.getElementById('network-status-icon').classList.remove('online');
                    document.getElementById('network-status-icon').classList.add('offline');
                    document.getElementById('network-status-icon').src = "{{ url_for('static', filename='web.png') }}"; 
                }
            })
            .catch(error => {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å–µ—Ç–∏:", error);
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–∏–Ω–≥–∞ —Å–µ—Ä–≤–µ—Ä–∞ –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        function pingServer() {
            fetch("/ping", { method: "GET" })
            .then(response => response.json())
            .then(data => {
                const isPingSuccessful = data.ping;

                if (isPingSuccessful) {
                    // –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω, –º–µ–Ω—è–µ–º –∏–∫–æ–Ω–∫—É –Ω–∞ "online" –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
                    document.getElementById('ping-icon').src = "{{ url_for('static', filename='ping_online.png') }}";
                } else {
                    // –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –º–µ–Ω—è–µ–º –∏–∫–æ–Ω–∫—É –Ω–∞ "offline" –∏ –¥–µ–ª–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–µ—Ä—ã–º
                    document.getElementById('ping-icon').src = "{{ url_for('static', filename='ping_offline.png') }}";
                }
            })
            .catch(error => {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∏–Ω–≥–µ —Å–µ—Ä–≤–µ—Ä–∞:", error);
            });
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ç–∏ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
        setInterval(checkNetworkStatus, 5000);
        checkNetworkStatus();

        // –ü–∏–Ω–≥ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = pingServer;
  </script>
<script type="module">
import {
  UserAgent,
  Registerer,
  Inviter,
  SessionState
} from "{{ url_for('static', filename='lib/index.js') }}";

let userAgent;
let registerer;
let session;

fetch('/get_config')
  .then(res => res.json())
  .then(config => {
    document.getElementById('sip-username').value = config.username || '';
    document.getElementById('sip-password').value = config.password || '';
    document.getElementById('sip-domain').value = config.server || '';
    document.getElementById('targetNumber').value = config.operator || '';
    registerSIP();
  });

function registerSIP() {
  const username = document.getElementById('sip-username').value;
  const password = document.getElementById('sip-password').value;
  const domain = document.getElementById('sip-domain').value;
  const uri = `sip:${username}@${domain}`;
  const wsServer = `wss://${domain}:7443`;

  if (userAgent) userAgent.stop();

  userAgent = new UserAgent({
    uri: UserAgent.makeURI(uri),
    transportOptions: { server: wsServer },
    authorizationUsername: username,
    authorizationPassword: password,
delegate: {
  onInvite: async (invitation) => {
    console.log("üìû –í—Ö–æ–¥—è—â–∏–π –≤—ã–∑–æ–≤ (–∞–≤—Ç–æ–æ—Ç–≤–µ—Ç)");

    session = invitation;

    // –ü–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    invitation.stateChange.addListener(async (state) => {
      if (state === SessionState.Established) {
        console.log("‚úÖ –í—ã–∑–æ–≤ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –º–µ–¥–∏–∞–ø–æ—Ç–æ–∫–∏...");

        const pc = invitation.sessionDescriptionHandler.peerConnection;
        const remoteStream = new MediaStream();

        pc.getReceivers().forEach((receiver) => {
          if (receiver.track) {
            remoteStream.addTrack(receiver.track);
          }
        });

        const remoteAudio = document.getElementById('remoteAudio');
        const remoteVideo = document.getElementById('remoteVideo');

        remoteAudio.srcObject = remoteStream;
        remoteVideo.srcObject = remoteStream;
        remoteAudio.muted = false;


          try {
            const audioContext = new AudioContext();
            const source = audioContext.createMediaStreamSource(remoteStream);
            source.connect(audioContext.destination);
            console.log("üîä –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Web Audio API");
          } catch (e) {
            console.error("‚ùå –û—à–∏–±–∫–∞ Web Audio API:", e);
          }
      }
    });

    try {
      await invitation.accept({
        sessionDescriptionHandlerOptions: {
          constraints: { audio: true, video: true }
        }
      });
    } catch (err) {
      console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç–µ:", err);
    }
  }
}

  });
  userAgent.start().then(() => {
    registerer = new Registerer(userAgent);
    return registerer.register();
  }).then(() => {
    console.log("‚úÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –∫–∞–∫", uri);
    document.getElementById('status').innerText = `–ü–æ–¥–∫–ª—é—á–µ–Ω –∫–∞–∫ ${uri}`;
    document.getElementById('login-block').style.display = 'none';
    document.getElementById('call-block').style.display = 'block';
  }).catch(err => {
    console.error("‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:", err);
    alert("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: " + (err.message || err));
  });
}

function makeCall() {
  const target = document.getElementById('targetNumber').value;
  const domain = document.getElementById('sip-domain').value;
  const targetURI = UserAgent.makeURI(`sip:${target}@${domain}`);
const ringback = document.getElementById('ringback');
let playCount = 0;
const maxPlays = 3;
const pauseBetweenPlays = 1000; // 1 —Å–µ–∫—É–Ω–¥–∞ (–≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö)

function handleEndedWithPause() {
  playCount++;
  if (playCount < maxPlays) {
    setTimeout(() => {
      ringback.currentTime = 0;
      ringback.play().catch(err => console.error("üîÅ –û—à–∏–±–∫–∞ –ø–æ–≤—Ç–æ—Ä–∞:", err));
    }, pauseBetweenPlays);
  } else {
    console.log("‚úÖ –ê—É–¥–∏–æ –ø—Ä–æ–∏–≥—Ä–∞–Ω–æ 3 —Ä–∞–∑–∞ —Å –ø–∞—É–∑–∞–º–∏.");
    ringback.removeEventListener('ended', handleEndedWithPause);
    playCount = 0;
  }
}

ringback.addEventListener('ended', handleEndedWithPause);

// –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫
ringback.play().catch(err => console.error("‚ùå –û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:", err));
  navigator.mediaDevices.getUserMedia({ audio: true, video: true }).then((stream) => {
    document.getElementById('localVideo').srcObject = stream;

    const inviter = new Inviter(userAgent, targetURI, {
      sessionDescriptionHandlerOptions: {
        constraints: { audio: true, video: true },
        stream: stream
      }
    });

    session = inviter;

    inviter.stateChange.addListener((state) => {
      if (state === SessionState.Established) {
        const pc = inviter.sessionDescriptionHandler.peerConnection;
        const remoteStream = new MediaStream();
        pc.getReceivers().forEach(receiver => {
          if (receiver.track) remoteStream.addTrack(receiver.track);
        });

        const remoteAudio = document.getElementById('remoteAudio');
        remoteAudio.srcObject = remoteStream;
        remoteAudio.play().catch(err => {
          console.error("–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∞—É–¥–∏–æ:", err);
        });

        const remoteVideo = document.getElementById('remoteVideo');
        remoteVideo.srcObject = remoteStream;
      }
    });

    inviter.invite().catch(err => {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–≤–æ–Ω–∫–µ:", err);
      alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–≤–æ–Ω–∫–µ: " + err.message || err);
    });
  }).catch(err => {
    console.error("getUserMedia error:", err);
    alert("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É: " + err.message);
  });
}

function hangupCall() {
  if (session) {
    session.bye();
    session = null;
  }
}

function saveConfig() {
  const config = {
    username: document.getElementById('sip-username').value,
    password: document.getElementById('sip-password').value,
    server: document.getElementById('sip-domain').value,
    operator: document.getElementById('targetNumber').value
  };

  fetch('/save_sip_config', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(config)
  }).then(res => {
    if (!res.ok) alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫");
  });
}

window.addEventListener('storage', (event) => {
  if (event.key === 'trigger-register') {
    console.log("üîÅ –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é");
    registerSIP();
  }
});

window.makeCall = makeCall;
window.hangupCall = hangupCall;
window.registerSIP = registerSIP;
window.saveConfig = saveConfig;
setInterval(() => {
  fetch('/api/check_trigger').then(res => {
    if (res.status === 200) {
      makeCall(); // –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ñ–ª–∞–≥ –Ω–∞–π–¥–µ–Ω
    }
  });
}, 1000);

</script>
</body>
</html>
