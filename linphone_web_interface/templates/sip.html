<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>SIP.js –¢–µ–ª–µ—Ñ–æ–Ω (FreeSWITCH)</title>
</head>
<body>
  <h2>SIP.js –¢–µ–ª–µ—Ñ–æ–Ω (FreeSWITCH)</h2>

  <!-- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è SIP -->
  <div id="login-block">
    <input type="text" id="sip-username" placeholder="SIP Username">
    <input type="password" id="sip-password" placeholder="SIP Password">
    <input type="text" id="sip-domain" placeholder="SIP Domain (e.g., freeswitch.local)">
    <button onclick="registerSIP(); saveConfig();">–í–æ–π—Ç–∏</button>
  </div>

  <!-- –ó–≤–æ–Ω–∫–∏ -->
  <div id="call-block" style="display: none;">
    <input type="text" id="targetNumber" placeholder="–ö—É–¥–∞ –∑–≤–æ–Ω–∏—Ç—å">
    <button onclick="makeCall()">–ü–æ–∑–≤–æ–Ω–∏—Ç—å</button>
    <button onclick="hangupCall()">–°–±—Ä–æ—Å–∏—Ç—å</button>
    <p><b>–°—Ç–∞—Ç—É—Å:</b> <span id="status">–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω</span></p>

    <div>
      <h3>–õ–æ–∫–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ</h3>
      <video id="localVideo" autoplay muted playsinline style="width: 240px;"></video>
      <h3>–£–¥–∞–ª—ë–Ω–Ω–æ–µ –≤–∏–¥–µ–æ</h3>
      <video id="remoteVideo" autoplay playsinline style="width: 240px;"></video>
    </div>
  </div>

  <!-- –í—Ö–æ–¥—è—â–∏–π -->
  <div id="incoming-call" style="display:none;">
    <p>–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫</p>
    <button id="acceptBtn">–ü—Ä–∏–Ω—è—Ç—å</button>
    <button id="rejectBtn">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
  </div>
  <audio id="remoteAudio" autoplay></audio>
<script type="module">
import {
  UserAgent,
  Registerer,
  Inviter,
  SessionState
} from "{{ url_for('static', filename='lib/index.js') }}";

let userAgent;
let registerer;
let session;

fetch('/get_config')
  .then(res => res.json())
  .then(config => {
    document.getElementById('sip-username').value = config.username || '';
    document.getElementById('sip-password').value = config.password || '';
    document.getElementById('sip-domain').value = config.server || '';
    document.getElementById('targetNumber').value = config.operator || '';
    registerSIP();
  });

function registerSIP() {
  const username = document.getElementById('sip-username').value;
  const password = document.getElementById('sip-password').value;
  const domain = document.getElementById('sip-domain').value;
  const uri = `sip:${username}@${domain}`;
  const wsServer = `wss://${domain}:7443`;

  if (userAgent) userAgent.stop();

  userAgent = new UserAgent({
    uri: UserAgent.makeURI(uri),
    transportOptions: { server: wsServer },
    authorizationUsername: username,
    authorizationPassword: password,
delegate: {
  onInvite: async (invitation) => {
    console.log("üìû –í—Ö–æ–¥—è—â–∏–π –≤—ã–∑–æ–≤ (–∞–≤—Ç–æ–æ—Ç–≤–µ—Ç)");

    session = invitation;

    // –ü–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    invitation.stateChange.addListener(async (state) => {
      if (state === SessionState.Established) {
        console.log("‚úÖ –í—ã–∑–æ–≤ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –º–µ–¥–∏–∞–ø–æ—Ç–æ–∫–∏...");

        const pc = invitation.sessionDescriptionHandler.peerConnection;
        const remoteStream = new MediaStream();

        pc.getReceivers().forEach((receiver) => {
          if (receiver.track) {
            remoteStream.addTrack(receiver.track);
          }
        });

        const remoteAudio = document.getElementById('remoteAudio');
        const remoteVideo = document.getElementById('remoteVideo');

        remoteAudio.srcObject = remoteStream;
        remoteVideo.srcObject = remoteStream;
        remoteAudio.muted = false;


          try {
            const audioContext = new AudioContext();
            const source = audioContext.createMediaStreamSource(remoteStream);
            source.connect(audioContext.destination);
            console.log("üîä –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Web Audio API");
          } catch (e) {
            console.error("‚ùå –û—à–∏–±–∫–∞ Web Audio API:", e);
          }
      }
    });

    try {
      await invitation.accept({
        sessionDescriptionHandlerOptions: {
          constraints: { audio: true, video: true }
        }
      });
    } catch (err) {
      console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç–µ:", err);
    }
  }
}

  });
  userAgent.start().then(() => {
    registerer = new Registerer(userAgent);
    return registerer.register();
  }).then(() => {
    console.log("‚úÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –∫–∞–∫", uri);
    document.getElementById('status').innerText = `–ü–æ–¥–∫–ª—é—á–µ–Ω –∫–∞–∫ ${uri}`;
    document.getElementById('login-block').style.display = 'none';
    document.getElementById('call-block').style.display = 'block';
  }).catch(err => {
    console.error("‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:", err);
    alert("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: " + (err.message || err));
  });
}

function makeCall() {
  const target = document.getElementById('targetNumber').value;
  const domain = document.getElementById('sip-domain').value;
  const targetURI = UserAgent.makeURI(`sip:${target}@${domain}`);

  navigator.mediaDevices.getUserMedia({ audio: true, video: true }).then((stream) => {
    document.getElementById('localVideo').srcObject = stream;

    const inviter = new Inviter(userAgent, targetURI, {
      sessionDescriptionHandlerOptions: {
        constraints: { audio: true, video: true },
        stream: stream
      }
    });

    session = inviter;

    inviter.stateChange.addListener((state) => {
      if (state === SessionState.Established) {
        const pc = inviter.sessionDescriptionHandler.peerConnection;
        const remoteStream = new MediaStream();
        pc.getReceivers().forEach(receiver => {
          if (receiver.track) remoteStream.addTrack(receiver.track);
        });

        const remoteAudio = document.getElementById('remoteAudio');
        remoteAudio.srcObject = remoteStream;
        remoteAudio.play().catch(err => {
          console.error("–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∞—É–¥–∏–æ:", err);
        });

        const remoteVideo = document.getElementById('remoteVideo');
        remoteVideo.srcObject = remoteStream;
      }
    });

    inviter.invite().catch(err => {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–≤–æ–Ω–∫–µ:", err);
      alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–≤–æ–Ω–∫–µ: " + err.message || err);
    });
  }).catch(err => {
    console.error("getUserMedia error:", err);
    alert("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É: " + err.message);
  });
}

function hangupCall() {
  if (session) {
    session.bye();
    session = null;
  }
}

function saveConfig() {
  const config = {
    username: document.getElementById('sip-username').value,
    password: document.getElementById('sip-password').value,
    server: document.getElementById('sip-domain').value,
    operator: document.getElementById('targetNumber').value
  };

  fetch('/save_sip_config', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(config)
  }).then(res => {
    if (!res.ok) alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫");
  });
}

window.addEventListener('storage', (event) => {
  if (event.key === 'trigger-register') {
    console.log("üîÅ –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é");
    registerSIP();
  }
});

window.makeCall = makeCall;
window.hangupCall = hangupCall;
window.registerSIP = registerSIP;
window.saveConfig = saveConfig;
setInterval(() => {
  fetch('/api/check_trigger').then(res => {
    if (res.status === 200) {
      makeCall(); // –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ñ–ª–∞–≥ –Ω–∞–π–¥–µ–Ω
    }
  });
}, 1000);

</script>

</body>
</html>
